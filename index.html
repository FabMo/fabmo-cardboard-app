<!DOCTYPE html>
<html lang="en"> 
<head>
<meta name="viewport" content="width=device-width, initial-scale=1" charset="utf-8"/>
<link rel="stylesheet" href="css/jquery.mobile-1.4.5.css">

<script>
SVGElement.prototype.getTransformToElement = SVGElement.prototype.getTransformToElement || function(toElement) {
    return toElement.getScreenCTM().inverse().multiply(this.getScreenCTM());
};
</script>

<script src="js/flatten.js"></script>

<script src="js/jquery-1.11.2.min.js"></script>
<script src="js/libs/fabmo.js"></script>
    <script type="text/javascript">
        var fabmo = new FabMoDashboard();
    </script>
<script src="js/jquery.mobile-1.4.5.js"></script>
<!--<script src="js/processing.min.js"></script>-->
<script src="js/raphael-min.js"></script>
<script src="js/simplify.js"></script>
<style>

#loadfont {
  position: relative;
  overflow: hidden;
  float: center;
  margin-right: 4px;
}
#loadfont input {
  position: absolute;
  top: 0;
  right: 0;
  margin: 0;
  opacity: 0;
  filter: alpha(opacity=0);
  transform: translate(-300px, 0) scale(4);
  font-size: 23px;
  direction: ltr;
  cursor: pointer;
}

#svg{

   position: absolute;
   height: 50vh;
   width: 50vw;
   left: -999px;
   top: -999px;

}

</style>
</head>

<div id="shape">



<svg id="svg" version="1.1" xmlns="http://www.w3.org/2000/svg" height="628" width="726"><polygon points="0,150 0,50 100,0 200,50 200,150 100,200 0,150" fill="white" stroke="black" stroke-width="4"/></svg>

</div>

<body onload="load()">

<div data-role="page" id="pageone">
  <div data-role="header">

<!--
 
      <a href="#" class="ui-btn ui-corner-all ui-shadow ui-icon-eye ui-btn-icon-left" onclick="toggleFullScreen();">FULLSCREEN</a>
     <a href="#" class="ui-btn ui-corner-all ui-shadow ui-icon-info ui-btn-icon-left" onclick="info();">JOB INFO</a> 
-->

    <h1>CARDBOARD</h1>

    <div data-role="navbar">
      <ul>
        <li><a href="#pagezero">SETUP</a></li>
        <li><a href="#pageone" onclick="" class="ui-btn-active ui-state-persist">LOAD SVG</a></li>

      </ul>
    </div>
  </div>
  
  <div data-role="main" class="ui-content">

	<canvas id="myCanvas"></canvas>

  </div>
  <div data-role="footer" style="text-align:center;">

    <span class="ui-btn ui-corner-all ui-shadow ui-icon-plus ui-btn-icon-left" id="loadfont" onchange="startRead()">
       <span>LOAD SVG</span>
       <input type="file" name="files[]" id="file" multiple data-role="none"/>
    </span>

<!--
<a href="#" id="resize" class="ui-btn ui-corner-all ui-shadow ui-icon-gear ui-btn-icon-left">RESIZE</a>
-->

      <a href="#" class="ui-btn ui-corner-all ui-shadow ui-icon-action ui-btn-icon-right" onclick="make();">SUBMIT JOB</a>
  </div>
</div> 


<div data-role="page" id="pagezero">
  <div data-role="header">

<!--
    <a href="#" class="ui-btn ui-corner-all ui-shadow ui-icon-eye ui-btn-icon-left" onclick="toggleFullScreen();">FULLSCREEN</a>
-->

    <h1>SETUP</h1>

    <div data-role="navbar">
      <ul>
        <li><a href="#pagezero" class="ui-btn-active ui-state-persist">SETUP</a></li>
        <li><a href="#pageone" onclick="sawtooth(); draw();">LOAD SVG</a></li>

      </ul>
    </div>
  </div>
  <div data-role="main" class="ui-content">

    <form method="post">
      <fieldset class="ui-field-contain">
        <label for="material">MATERIAL TYPE</label>
        <select name="material" id="material">
          <option value="feed:1000,plunge:200" selected>CARDBOARD</option>
        </select>
      </fieldset>
    </form>




    <form method="post">
      <fieldset class="ui-field-contain">
        <label for="code">FILE TYPE</label>
        <select name="code" id="code">
          <option value="gcode" selected>GCODE (saw profile)</option>
          <option value="sbp">SBP ("MI" oscillation)</option>

        </select>
      </fieldset>
    </form>

   <form method="post">
      <fieldset class="ui-field-contain">
        <label for="saw">SAW CUT</label>
        <select name="saw" id="saw">
          <option value="triangle">TRIANGLE</option>
          <option value="sawtooth" selected>SAWTOOTH</option>
        </select>
      </fieldset>
    </form>

    <form method="post">
      <fieldset class="ui-field-contain">
        <label for="units">CUT FILE UNITS</label>
        <select name="units" id="units">
          <option value="inch">INCH</option>
          <option value="mm" selected>MM</option>
        </select>
      </fieldset>
    </form>

    <form method="post">
      <fieldset class="ui-field-contain">
        <label for="retract">RETRACT ANGLE (deg)</label>
		  <input name="retract" id="retract" type="number" value="20" step="1" autocomplete="off" min="5">
      </fieldset>
    </form>

    <form method="post">
      <fieldset class="ui-field-contain">
        <label for="depth">CUT DEPTH (inch)</label>
		  <input name="depth" id="depth" type="number" value="-0.25" step="0.05" autocomplete="off" max="0">
      </fieldset>
    </form>

    <form method="post">
      <fieldset class="ui-field-contain">
        <label for="amplitutde">AMPLITUDE (inch)</label>
		  <input name="amplitude" id="amplitude" type="number" value="0.1" step="0.05" autocomplete="off" min="0">
      </fieldset>
    </form>

    <form method="post">
      <fieldset class="ui-field-contain">
        <label for="cutlength">CUT LENGTH (inch)</label>
		  <input name="cutlength" id="cutlength" type="number" value="0.06" step="0.01" autocomplete="off" min="0.01">
      </fieldset>
    </form>


    <form method="post">
      <fieldset class="ui-field-contain">
        <label for="feedrate">FEEDRATE (inch/sec)</label>
		  <input name="feedrate" id="feedrate" type="number" value="1" step="1" autocomplete="off" min="1">
      </fieldset>
    </form>

</div>
  <div data-role="footer" style="text-align:center;">

    <a href="#pageone" class="ui-btn ui-corner-all ui-shadow ui-icon-carat-r ui-btn-icon-right" onclick="sawtooth(); draw();">LOAD SVG</a>
  </div>
</div> 

<script>

var sf = 1

function draw(){

c = document.getElementById("myCanvas")
ctx = c.getContext("2d")
	
ctx.canvas.height = $(window).height()-180
ctx.canvas.width = $(window).width()-30

ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);
ctx.fillStyle = "#E0E0F8"
ctx.lineWidth = 1
ctx.fillStyle = "#E0E0F8"
ctx.strokeStyle = "#ff0000"

sf=((ctx.canvas.height-5)/(ymax-ymin))

ctx.translate((-xmin*sf)+5,(-ymin*sf)+2)

ctx.beginPath()
ctx.fillRect((xmin*sf)-2,(ymin*sf)-2,((xmax-xmin)*sf)+4,((ymax-ymin)*sf)+4)
ctx.fill()

   for(i=0;i<dots.length;i++){
   ctx.beginPath()

		
      for(j=0;j<dots[i].length;j++){
              ctx.lineTo(dots[i][j].x*sf,dots[i][j].y*sf)
      }
   ctx.stroke()
   }


   for(i=0;i<saw.length;i++){
   ctx.beginPath()

		
      for(j=0;j<saw[i].length;j++){
              //ctx.lineTo(saw[i][j].x*sf,saw[i][j].y*sf)
      }
   ctx.stroke()
   }

ctx.strokeStyle = "#333"

   for(i=0;i<saw.length;i++){
   
      for(j=0;j<saw[i].length;j++){

					//if(dots[i][j].r==true){
					ctx.beginPath()
				   	//ctx.moveTo(dots[i][j].x*sf,dots[i][j].y*sf)
		    			//ctx.arc(dots[i][j].x*sf,dots[i][j].y*sf,(1),0,2*Math.PI)
						//console.log(i + " " + j)

				   	ctx.moveTo(saw[i][j].x*sf,saw[i][j].y*sf)
		    			ctx.arc(saw[i][j].x*sf,saw[i][j].y*sf,(1),0,2*Math.PI)
   				ctx.stroke()
					//}
      }

	}

	ctx.beginPath()
	ctx.fillStyle = "#000"
	ctx.font = "14px Arial"
	ctx.fillText( (((xmax-xmin)/sf2)/96).toFixed(2) + " x " + (((ymax-ymin)/sf2)/96).toFixed(2) + "\"",(xmax*sf)+5,ymax*sf)


}

//TODO

//angle > 360
//

var g = ""
var SVG = []
var SVG2 = []
var SVG3 = ""
var dots = []
var image = ({name:"hex.svg"})
var xmin
var xmax
var ymin
var ymax
var sf2 = 1
var target_width = 101.6
var tool_diameter
var retract_angle = 20
var message

var SVG_saw = []
var saw = []

var svg_units

var job_info 

function info(){

message = (image.name + "\noriginal size = \nwidth: " + ((xmax-xmin)).toFixed(2) + " px" + "\nheight: " + ((ymax-ymin)).toFixed(2)+ " px") 

fabmo.notify('info',message)

}

function load(){
   svg2pg()
}


function startRead() {
    image = document.getElementById("file").files[0];
    if (image) {
        if (image.type.match("/svg/*")) {
            getAsImage(image);
        }
        else {
//              alert(image.name + " IS NOT A SVG FILE");
        }
    }
}

function getAsImage(readFile) {
    var reader = new FileReader();
    reader.readAsDataURL(readFile);
    reader.onload = addImg;
}

function addImg(imgsrc) {

   SVG2 = imgsrc.target.result
   SVG2 = SVG2.slice(SVG2.indexOf(",")+1)
   SVG2 = window.atob(SVG2)

   SVG2 = SVG2.slice((SVG2.indexOf('<svg')),(SVG2.indexOf('</svg'))+6)

   SVG2 = SVG2.replace('<svg','<svg id="svg"')

svg_units = SVG2.match(/width=\"(.*?)\"/);

if(svg_units==null){
	svg_units = ".px"

}
else{
	svg_units = svg_units[1]
	svg_units = svg_units.replace(/[0-9]/g, '')
}

   $( "#svg" ).replaceWith(SVG2);
   svg2pg()
}

function svg2pg(){

   svg_paths=[]
   SVG = []
   SVG2 = []
   dots = []
   SVG3 = ''
   flatten(document.getElementById('svg'));

   for(i=0;i<svg_paths.length;i++){
   SVG.push([])
      for(j=0;j<svg_paths[i].length;j++){

      SVG[i]+=(svg_paths[i][j])

      }
   }

   svg_paths=[]
   for(i=0;i<SVG.length;i++){
      svg_paths[i]=Raphael._pathToAbsolute(SVG[i]);    
   }

   SVG=[]

   var curve
   var shape_no = 0

   for(i=0;i<svg_paths.length;i++){
   for(j=0;j<svg_paths[i].length;j++){
            if((svg_paths[i][j][0].startsWith('M')==true) || (svg_paths[i][j][0].startsWith('m')==true)){
               dots.push([])
               shape_no=dots.length-1
               dots[shape_no].push({x:svg_paths[i][j][1],y:svg_paths[i][j][2]})
					//console.log(svg_paths[i][j][1] + " " + svg_paths[i][j][2])
            }

            else if((svg_paths[i][j][0].startsWith('L')==true) || (svg_paths[i][j][0].startsWith('l')==true)){
               dots[shape_no].push({x:svg_paths[i][j][1],y:svg_paths[i][j][2]})
            }
            else if((svg_paths[i][j][0].startsWith('Z')==false) && (svg_paths[i][j][0].startsWith('z')==false)){
               curve = ""
               for(j2=0;j2<svg_paths[i][j].length;j2++){
                  curve +=(svg_paths[i][j][j2]+',')
               }
                  curve = "M," + (svg_paths[i][j-1][(svg_paths[i][j-1].length)-2]) + ',' + (svg_paths[i][j-1][(svg_paths[i][j-1].length)-1]) + ',' + curve
        			//if units !=in          
					if((svg_units==".in")){
						l=0
						var length = Raphael.getTotalLength(curve)
						while(l<Raphael.getTotalLength(curve)){
							l=l+0.01									
							dots[shape_no].push({x:Raphael.getPointAtLength(curve, l).x,y:Raphael.getPointAtLength(curve, l).y})
						}
					}
					else{
               	for(l=1;l<(parseInt(Raphael.getTotalLength(curve)));l++){
                  	dots[shape_no].push({x:Raphael.getPointAtLength(curve, l).x,y:Raphael.getPointAtLength(curve, l).y})   
               	}
					}
           
            }
   	}

   }


   xmin = []
   xmax = []
   ymin = []
   ymax = []

   for(i=0;i<dots.length;i++){
      for(j=0;j<dots[i].length;j++){
      xmax.push(dots[i][j].x)
      xmin.push(dots[i][j].x)
      ymax.push(dots[i][j].y)
      ymin.push(dots[i][j].y)
      }
		
   }
   xmax = Math.max.apply(Math, xmax)
   xmin = Math.min.apply(Math, xmin)
   ymax = Math.max.apply(Math, ymax)
   ymin = Math.min.apply(Math, ymin)
   //sf2 = ((xmax-xmin)/target_width)

scale()

sf2 = 1

draw()
//	sf2 = ((xmax-xmin)/96) //inches

}

function scale(){

//console.log(dots)

for(i=0;i<dots.length;i++){
   dots[i].push(dots[i][0])
}

	if((svg_units==".in") && (svg_units!=undefined)){

	for(i=0;i<dots.length;i++){
		for(j=0;j<dots[i].length;j++){

	//	console.log(dots[i][j].x*96)
	dots[i][j] = ({x:dots[i][j].x*96,y:dots[i][j].y*96})
	
		}
	
	}
	
	xmin *= 96
	xmax *= 96
	ymin *= 96
	ymax *= 96

}


for(i=0;i<dots.length;i++){
	  dots[i]=simplify(dots[i], 0.1, true)
}



sawtooth()

}


$( "#resize" ).click(function() {

   target_width = eval(window.prompt("ENTER NEW WIDTH (INCH)")*96)

   if((target_width!=0)){
		//sf2=1
      sf2 = ((xmax-xmin)/target_width)
		//sf2 = ((xmax-xmin)/96) //96dpi
   }
	
});


$(window).resize(function(){
	draw()
}); 


// toggle full screen
function toggleFullScreen() {
   if (!document.fullscreenElement &&    // alternative standard method
      !document.mozFullScreenElement && !document.webkitFullscreenElement) {  // current working methods
    if (document.documentElement.requestFullscreen) {
      document.documentElement.requestFullscreen()
    } else if (document.documentElement.mozRequestFullScreen) {
      document.documentElement.mozRequestFullScreen()
    } else if (document.documentElement.webkitRequestFullscreen) {
      document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT)
    }
  } else {
    if (document.cancelFullScreen) {
      document.cancelFullScreen()
    } else if (document.mozCancelFullScreen) {
      document.mozCancelFullScreen()
    } else if (document.webkitCancelFullScreen) {
      document.webkitCancelFullScreen()
    }
  }
}

function sawtooth(){

var a 
var ia
var b
var ib 
var d  

for(i=0;i<dots.length;i++){

	a = (parseFloat((Math.atan2(dots[i][1].x-dots[i][0].x,dots[i][1].y-dots[i][0].y)*(180/Math.PI)).toFixed(2)))
	dots[i][0].a = a
   dots[i][0].r = true
	dots[i][dots[i].length-1].r = true

   for(j=1;j<dots[i].length-1;j++){
			b = a
			a = (parseFloat((Math.atan2(dots[i][j+1].x-dots[i][j].x,dots[i][j+1].y-dots[i][j].y)*(180/Math.PI)).toFixed(2)))
			

			if(a<=0){
				ia = (a + 360)
			}
			else{
				ia = (a - 360)
			}
			
			if( Math.abs(ia-b)<=(Math.abs(a-b)) ){
				a = ia
				
			}
			

			if (Math.abs(360-b)+a<Math.abs(b-a)){
				d = Math.abs(360-b)+a
			}			
			else{
				d = Math.abs(b - a)
			}

			
			if(d>(retract_angle) ){

			dots[i][j].r = true				
			
			}
			else{
			dots[i][j].r = false
			}

         dots[i][j].a = a
			//dots[i][j].d = d
			
   	}
}

SVG_saw = []


var paths = []
var index = 0
var start = 0


for(i=0;i<dots.length;i++){

//SVG_saw.push([[]])
start = index

	for(j=0;j<dots[i].length-1;j++){
	
	if((dots[i][j].r==true)&&(j==0)){
	//SVG_saw[i].push("hi")	
	SVG_saw.push("M"+(dots[i][j].x).toFixed(3)+" "+(dots[i][j].y).toFixed(3))
	index++
	SVG_saw[SVG_saw.length-1]+=(" L "+(dots[i][j+1].x).toFixed(3)+" "+(dots[i][j+1].y).toFixed(3))
	}

	
	else if((dots[i][j].r==true)&&(j!=0)){
	
	SVG_saw[SVG_saw.length-1]+=(" L "+(dots[i][j].x).toFixed(3)+" "+(dots[i][j].y).toFixed(3))
	
	SVG_saw.push("M"+(dots[i][j].x).toFixed(3)+" "+(dots[i][j].y).toFixed(3))
	index++	
	SVG_saw[SVG_saw.length-1]+=(" L "+(dots[i][j+1].x).toFixed(3)+" "+(dots[i][j+1].y).toFixed(3))
	
	}
	
	else{
	SVG_saw[SVG_saw.length-1]+=(" L "+(dots[i][j].x).toFixed(3)+" "+(dots[i][j].y).toFixed(3))
	}	
	
	}

	SVG_saw[SVG_saw.length-1]+=(" L "+(dots[i][dots[i].length-1].x).toFixed(3)+" "+(dots[i][dots[i].length-1].y).toFixed(3))
	
	//console.log(start + " " + index)
	paths.push([])
	for(start=start;start<index;start++)
	{
	paths[paths.length-1].push(SVG_saw[start])	
	}

}	



saw = []

//console.log(SVG_saw)

var cutlength=96*document.getElementById("cutlength").value

for(i=0;i<paths.length;i++){

saw.push([])

saw[i].push(dots[i][0])	

	for(j=0;j<paths[i].length;j++){

	l=parseFloat(((Raphael.getTotalLength(paths[i][j]))/(Math.ceil(Raphael.getTotalLength(paths[i][j])/cutlength))).toFixed(3))

		for(j2=l;j2<(Raphael.getTotalLength(paths[i][j])-1);j2=j2+l){

			saw[i].push({x:parseFloat((Raphael.getPointAtLength(paths[i][j], j2).x).toFixed(6)),y:parseFloat((Raphael.getPointAtLength(paths[i][j], j2).y).toFixed(6))})

		}

saw[i].push({x:parseFloat((Raphael.getPointAtLength(paths[i][j], (Raphael.getTotalLength(paths[i][j]))).x).toFixed(6)),y:parseFloat((Raphael.getPointAtLength(paths[i][j], (Raphael.getTotalLength(paths[i][j]))).y).toFixed(6))})
		

}


}

//console.log(saw)

for(i=0;i<saw.length;i++){

	a = 0-(parseFloat((Math.atan2((saw[i][0].x-saw[i][1].x),(saw[i][0].y-saw[i][1].y))*(180/Math.PI)).toFixed(2)))
   //console.log(a)
   for(j=0;j<saw[i].length-1;j++){
	b = a
	//console.log(a)

	console.log(a)

	a = 0-(parseFloat((Math.atan2((saw[i][j].x-saw[i][j+1].x),(saw[i][j].y-saw[i][j+1].y))*(180/Math.PI)).toFixed(2)))
	
	saw[i][j].a=a

	if(Math.abs(b-a)>retract_angle){
		saw[i][j].r=true
	}

	else{
		saw[i][j].r=false
	}
	

	}

	console.log(a)	
	saw[i][saw[i].length-1].a=a
	saw[i][saw[i].length-1].r=false

}

console.log(saw)


var z=0  


for(i=0;i<saw.length;i++){
	
	z=0

   for(j=0;j<saw[i].length;j++){
		if(z!=0){
			z=0
		}
		else{
			z=1
		}

		saw[i][j].z = z

   	}
	}


}


function make(){


for(i=0;i<saw.length;i++){
	
	z=(parseFloat(document.getElementById("depth").value))

   for(j=0;j<saw[i].length;j++){
		if(z!=(parseFloat(document.getElementById("depth").value))){
			z=(parseFloat(document.getElementById("depth").value))
		}
		else{
			z=((parseFloat(document.getElementById("depth").value))+(parseFloat(document.getElementById("amplitude").value))).toFixed(3)
		}

		saw[i][j].z = z

   	}
}


var cut_depth = (document.getElementById("depth").value)

if((document.getElementById("code").value)=="gcode"){

	var feed = document.getElementById("feedrate").value*60 //inches/min
	var scale = 1

   g=""

	if(document.getElementById("units").value=="mm"){
   	g+="g21\n"
		scale = 25.4
   	g+="g0z5\n"
   	g+="g4p2\n"
   	g+="g1f" + (feed*scale) + "\n"
	}
	else{
   	g+="g20\n"
   	g+="g0z0.25\n"
   	g+="g4p2\n"
   	g+="g1f" + feed + "\n"
	}


for(i=0;i<saw.length;i++){

	g+="g0x"+((((saw[i][0].x-xmin)/sf2)/96)*scale).toFixed(3)+"y"+(((((ymax-ymin)/sf2)+((ymin-(saw[i][0].y))/sf2))/96)*scale).toFixed(3) +  "a" + saw[i][0].a + "\n"
	g+="g0z" + (saw[i][0].z*scale).toFixed(3) + "\n"

   for(j=1;j<saw[i].length-1;j++){

		if(saw[i][j].r==true){
//
			if((document.getElementById("saw").value=="sawtooth") && (saw[i][j].z==(parseFloat(document.getElementById("depth").value)))){

				g+="g1x"+((((saw[i][j].x-xmin)/sf2)/96)*scale).toFixed(3)+"y"+(((((ymax-ymin)/sf2)+((ymin-(saw[i][j].y))/sf2))/96)*scale).toFixed(3) + "z" + (saw[i][j].z*scale).toFixed(3) + "\n"

				g+="g0z" + ((parseFloat(document.getElementById("depth").value)*scale)+(parseFloat(document.getElementById("amplitude").value))*scale).toFixed(3) + "\n"
			}

			else if((document.getElementById("saw").value=="sawtooth") && (saw[i][j].z!=(parseFloat(document.getElementById("depth").value)))){

				g+="g1x"+((((saw[i][j].x-xmin)/sf2)/96)*scale).toFixed(3)+"y"+(((((ymax-ymin)/sf2)+((ymin-(saw[i][j].y))/sf2))/96)*scale).toFixed(3) + "z" + ((document.getElementById("depth").value)*scale).toFixed(3) + "\n"

				g+="g0z" + ((parseFloat(document.getElementById("depth").value)*scale)+(parseFloat(document.getElementById("amplitude").value))*scale).toFixed(3) + "\n"
			}

//			
			g+="g0z" + (0.125*scale).toFixed(3) + "\n"
			g+="g0a" + (saw[i][j].a) + "\n"

			g+="g0z" + ((parseFloat(document.getElementById("depth").value)*scale)+(parseFloat(document.getElementById("amplitude").value))*scale).toFixed(3) + "\n"
	
		}
		else{

			

			if((document.getElementById("saw").value=="sawtooth") && (saw[i][j].z==(parseFloat(document.getElementById("depth").value)))){

				g+="g1x"+((((saw[i][j].x-xmin)/sf2)/96)*scale).toFixed(3)+"y"+(((((ymax-ymin)/sf2)+((ymin-(saw[i][j].y))/sf2))/96)*scale).toFixed(3) + "z" + (saw[i][j].z*scale).toFixed(3) + "a" + saw[i][j].a +"\n"

				g+="g0z" + ((parseFloat(document.getElementById("depth").value)*scale)+(parseFloat(document.getElementById("amplitude").value))*scale).toFixed(3) + "\n"
			}
			else if((document.getElementById("saw").value=="sawtooth") && (saw[i][j].z!=(parseFloat(document.getElementById("depth").value)))){
				g+="g1x"+((((saw[i][j].x-xmin)/sf2)/96)*scale).toFixed(3)+"y"+(((((ymax-ymin)/sf2)+((ymin-(saw[i][j].y))/sf2))/96)*scale).toFixed(3) + "z" + ((document.getElementById("depth").value)*scale).toFixed(3) + "a" + saw[i][j].a +"\n"

				g+="g0z" + ((parseFloat(document.getElementById("depth").value)*scale)+(parseFloat(document.getElementById("amplitude").value))*scale).toFixed(3) + "\n"
			}

			else if(document.getElementById("saw").value!="sawtooth"){

			g+="g1x"+((((saw[i][j].x-xmin)/sf2)/96)*scale).toFixed(3)+"y"+(((((ymax-ymin)/sf2)+((ymin-(saw[i][j].y))/sf2))/96)*scale).toFixed(3) + "z" + (saw[i][j].z*scale) + "a" + saw[i][j-1].a +"\n"
			}

		}

   	}

			if((document.getElementById("saw").value=="sawtooth") && (saw[i][saw[i].length-1].z==(parseFloat(document.getElementById("depth").value)))){

				g+="g1x"+((((saw[i][saw[i].length-1].x-xmin)/sf2)/96)*scale).toFixed(3)+"y"+(((((ymax-ymin)/sf2)+((ymin-(saw[i][saw[i].length-1].y))/sf2))/96)*scale).toFixed(3) + "z" + (saw[i][saw[i].length-1].z*scale).toFixed(3) + "a" + saw[i][saw[i].length-1].a +"\n"

				g+="g0z" + ((parseFloat(document.getElementById("depth").value)*scale)+(parseFloat(document.getElementById("amplitude").value))*scale).toFixed(3) + "\n"
			}

			else if((document.getElementById("saw").value=="sawtooth") && (saw[i][saw[i].length-1].z!=(parseFloat(document.getElementById("depth").value)))){
				g+="g1x"+((((saw[i][j].x-xmin)/sf2)/96)*scale).toFixed(3)+"y"+(((((ymax-ymin)/sf2)+((ymin-(saw[i][saw[i].length-1].y))/sf2))/96)*scale).toFixed(3) + "z" + ((document.getElementById("depth").value)*scale).toFixed(3) + "a" + saw[i][saw[i].length-1].a +"\n"

				g+="g0z" + ((parseFloat(document.getElementById("depth").value)*scale)+(parseFloat(document.getElementById("amplitude").value))*scale).toFixed(3) + "\n"
			}
			else{
				g+="g1x"+((((saw[i][saw[i].length-1].x-xmin)/sf2)/96)*scale).toFixed(3)+"y"+(((((ymax-ymin)/sf2)+((ymin-(saw[i][saw[i].length-1].y))/sf2))/96)*scale).toFixed(3) + "z" + (saw[i][saw[i].length-2].z*scale).toFixed(3) + "a" + saw[i][saw[i].length-1].a +"\n"
			}

	g+="g0z" + (0.25*scale).toFixed(3) + "\n"

}


//	g+="g0z0.25\n"
//	g+="g4p0.5\n"
	g+="g0z" + (0.25*scale).toFixed(3) + "\n"
	g+="g0x0y0a0\n"
   g+="m30\n"


   fabmo.submitJob({
      file : g,
      filename : image.name + '.g',
      name : image.name,
      description : ((((xmax-xmin)/sf2)/96).toFixed(2))+" x "+((((ymax-ymin)/sf2)/96).toFixed(2))+"\""
   });


/*

	var feed = 20 //inches/min

   g=""
   g+="g20\n"
   g+="g0z0.375\n"
	g+="g0a0\n"
   g+="g4p2\n"
   g+="g1" + feed + "\n"

for(i=0;i<dots.length;i++){

   for(j=0;j<dots[i].length;j++){

           if(j==0){

           		g+="g0x"+(((dots[i][j].x-xmin)/sf2)/96).toFixed(3)+"y"+((((ymax-ymin)/sf2)+((ymin-(dots[i][j].y))/sf2))/96).toFixed(3) + "\n" 
			  		g+="g0a"+ (Math.atan2(dots[i][j+1].x-dots[i][j].x,dots[i][j+1].y-dots[i][j].y)).toFixed(3) +"\n"
           		g+="g1z-0.125f"+ (feed/2) + "\n"

           }
           else{
			  	if(j<dots[i].length-1){

					g+="g1x"+(((dots[i][j].x-xmin)/sf2)/96).toFixed(3)+"y"+((((ymax-ymin)/sf2)+((ymin-(dots[i][j].y))/sf2))/96).toFixed(3) + "f" + feed + "\n"


					var b = (Math.atan2(dots[i][j].x-dots[i][j-1].x,dots[i][j].y-dots[i][j-1].y)).toFixed(3)
					var a = (Math.atan2(dots[i][j+1].x-dots[i][j].x,dots[i][j+1].y-dots[i][j].y)).toFixed(3)

					if(Math.abs(a-b)>(retract_angle*(Math.PI/180))){
						g+="g0z0.25\n"				
						g+="g0a"+ (Math.atan2(dots[i][j+1].x-dots[i][j].x,dots[i][j+1].y-dots[i][j].y)).toFixed(3) +"\n"
           			g+="g1z-0.125f"+(feed/2)+"\n"
						g+="g1x"+(((dots[i][j].x-xmin)/sf2)/96).toFixed(3)+"y"+((((ymax-ymin)/sf2)+((ymin-(dots[i][j].y))/sf2))/96).toFixed(3) + "f" + feed + "\n"
					}
					else{
			  			g+="g0a"+ (Math.atan2(dots[i][j+1].x-dots[i][j].x,dots[i][j+1].y-dots[i][j].y)).toFixed(3) +"\n"
						g+="g1x"+(((dots[i][j].x-xmin)/sf2)/96).toFixed(3)+"y"+((((ymax-ymin)/sf2)+((ymin-(dots[i][j].y))/sf2))/96).toFixed(3) + "f" + feed + "\n"
					}
			  	}
				
				else{

						g+="g1x"+(((dots[i][j].x-xmin)/sf2)/96).toFixed(3)+"y"+((((ymax-ymin)/sf2)+((ymin-(dots[i][j].y))/sf2))/96).toFixed(3) + "f" + feed + "\n"
						
				
				}
				

			  }
           
   }

	g+="g0z0.25\n"


}



	g+="g0z0.25\n"
	g+="g4p0.5\n"
	g+="g0a0\n"
	g+="g0x0y0z0.375\n"
   g+="m30\n"


   fabmo.submitJob({
      file : g,
      filename : image.name + '.g',
      name : image.name,
      description : ((((xmax-xmin)/sf2)/96).toFixed(2))+" x "+((((ymax-ymin)/sf2)/96).toFixed(2))+"\""
   });
*/

}

else if((document.getElementById("code").value)=="sbp"){

	var a = 0 
	var b = 0	 

   g=""
//   g+="'UNITS = INCH\n"
   g+="JZ,0.25\n"
	g+="MB,0\n"
   g+="J2,0,0\n"

   g+="PAUSE 3\n"
   g+="MS,1,0.5\n"  //set feed,plunge

for(i=0;i<dots.length;i++){

   for(j=0;j<dots[i].length;j++){
           if(j==0){

           g+="J2,"+(((dots[i][j].x-xmin)/sf2)/96).toFixed(3)+","+((((ymax-ymin)/sf2)+((ymin-(dots[i][j].y))/sf2))/96).toFixed(3) + "\n" 

			  g+="MB,"+ (Math.atan2(dots[i][j+1].x-dots[i][j].x,dots[i][j+1].y-dots[i][j].y)*(180/Math.PI)).toFixed(3) +"\n"
           g+="MZ" + (document.getElementById("depth").value)+ "\n"
   		  g+="MI,Z,1,0,5,0.05\n"
			  
			  a = parseFloat((Math.atan2(dots[i][j+1].x-dots[i][j].x,dots[i][j+1].y-dots[i][j].y)*(180/Math.PI)).toFixed(3))

			  //console.log(a + " f")

           }
           else{
			  	if(j<dots[i].length-1){

					b = a

					a = parseFloat((Math.atan2(dots[i][j+1].x-dots[i][j].x,dots[i][j+1].y-dots[i][j].y)*(180/Math.PI)).toFixed(3))					
					
					//console.log(a-b)
					//console.log(a)

					if((Math.abs(a-b))>(retract_angle)){
						
						//console.log(Math.abs(b-a))

						g+="MI,0\n"
						g+="JZ,0.25\n"				
						g+="MB,"+ a +"\n"
           			g+="MZ" + (document.getElementById("depth").value)+ "\n"
   		 			g+="MI,Z,1,0,5,0.05\n"
						g+="M2,"+(((dots[i][j].x-xmin)/sf2)/96).toFixed(3)+","+((((ymax-ymin)/sf2)+((ymin-(dots[i][j].y))/sf2))/96).toFixed(3) + "\n"
					}

					else{
			  			g+="MB,"+ a +"\n"
						g+="M2,"+(((dots[i][j].x-xmin)/sf2)/96).toFixed(3)+","+((((ymax-ymin)/sf2)+((ymin-(dots[i][j].y))/sf2))/96).toFixed(3) + "\n"
					}
					
			  	}
			  	else{
					g+="M2,"+(((dots[i][j].x-xmin)/sf2)/96).toFixed(3)+","+((((ymax-ymin)/sf2)+((ymin-(dots[i][j].y))/sf2))/96).toFixed(3) + "\n"
					           
					}
           }
   }

g+="MI,0\n"
g+="JZ,0.25\n"

}

g+="MB,0\n"
g+="J3,0,0,0.25\n"

//console.log(g)


   fabmo.submitJob({
      file : g,
      filename : image.name + '.sbp',
      name : image.name,
      description : ((((xmax-xmin)/sf2)/96).toFixed(2))+" x "+((((ymax-ymin)/sf2)/96).toFixed(2))+" \""
   });


	}

}


</script>

</body>
</html>

