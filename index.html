<!DOCTYPE html>
<html lang="en"> 
<head>
<meta name="viewport" content="width=device-width, initial-scale=1" charset="utf-8"/>
<link rel="stylesheet" href="css/jquery.mobile-1.4.5.css">



<script src="js/jquery-1.11.2.min.js"></script>
<script src="js/libs/fabmo.js"></script>
    <script type="text/javascript">
        var fabmo = new FabMoDashboard();
    </script>
<script src="js/control.js"></script>
<script src="js/config.js"></script>
<script src="js/jquery.mobile-1.4.5.js"></script>
<script src="js/processing.min.js"></script>
<script src="js/opentype.min.js"></script>
<script src="js/snap.svg-min.js"></script>
<script src="js/clipper.js"></script>
<script src="js/flatten.js"></script>
<script src="js/raphael-min.js"></script>

<style>

#loadfont {
  position: relative;
  overflow: hidden;
  float: center;
  margin-right: 4px;
}
#loadfont input {
  position: absolute;
  top: 0;
  right: 0;
  margin: 0;
  opacity: 0;
  filter: alpha(opacity=0);
  transform: translate(-300px, 0) scale(4);
  font-size: 23px;
  direction: ltr;
  cursor: pointer;
}

#svg{

   position: absolute;
   height: 50vh;
   width: 50vw;
   left: -999px;
   top: -999px;

}


</style>
</head>

<div id="shape">
<svg id="svg">

<path d="M132-206c0,1-1,1-1,1h-1c-1,0-1-1-2-2,0,0-1-1-1-2s0-1,1-1l2,1c1,1,2,2,2,3m-18-10c0-5-2-8-5-8,0,0,0,1-1,1v2h3c0,2,1,3,1,5h2m35-5c2,0,3,2,4,5h2c-1-1-1-2-1-3s0-2-1-3-2-2-3-2c0,0-1,1-2,1,0,1,1,1,1,2m-30,16c-1,0-1,0-1-1s0-2,1-3c2,0,3-1,3-1,1,0,1,1,1,1,0,1-1,2-3,4h-1m-11-1c-4-2-5-5-5-10,0-3,0-5,2-7,1-2,3-3,5-3s3,1,5,3c1,3,2,6,2,9v1,1h1v-1c1,0,1-2,1-6,0-3,0-6-2-9s-4-5-8-5c-3,0-6,2-7,5-2,4-2.4,7-2.4,12,0,4,1.4,8,5.4,12,1-1,2-1,3-2m125,141c1,0,1-0.4,1-1.3,0-2.2-1-4.8-4-7.7-3-3-8-4.9-14-5.7-1-0.1-2-0.1-2-0.1-1-0.2-1-0.2-2-0.2-1-0.1-3-0.3-4-0.5,3-9.3,4-17.5,4-24.7,0-10-2-17-6-23s-8-9-13-10c-1,1-1,1-1,2,5,2,10,6,13,12,3,7,4,13,4,20,0,5.6-1,13.9-5,24.5-4,1.6-8,5.3-11,11.1,0,0.9,0,1.4,1,1.4,0,0,1-0.9,2-2.6,2-1.7,3-3.4,5-5.1,3-1.7,5-2.6,8-2.6,5,0,10,0.7,13,2.1,4,1.3,6,2.7,7,4.3,1,1.5,2,2.9,3,4.2,0,1.3,1,1.9,1,1.9m-92-145c-1-1-1-3-1-5,0-4,0-6,2-9,2-2,4-3,6-3,3,0,5,2,7,4,1,3,2,5,2,8,0,5-2,8-6,9,0,0,1,1,2,1,2,0,3,1,5,2,1-6,2-10,2-15,0-6-1-10-3-13-3-3-6-4-10-4-3,0-6,1-9,3-2,3-3,5-3,8,0,5,1,9,3,13,1,0,2,1,3,1m12,16c-13,9-23,13-31,13-7,0-14-3-20-8,1,2,2,4,3,5l6,6c4,4,9,6,14,6,7,0,15-4,25-11l9-6c2-2,4-4,4-7,0-1,0-2-1-2-1-2-6-5-16-8-9-4-16-6-20-6-3,0-8,2-15,6-6,4-10,8-10,12,0,0,1,1,2,3,6,5,12,8,18,8,8,0,18-4,31-14v2c1,0,1,1,1,1m23,202c4,7.52,11,11.3,19,11.3,2,0,4-0.3,6-0.9,2-0.4,4-1.1,5-1.9,1-0.7,2-1.4,3-2.2,2-0.7,2-1.2,3-1.7l17-14.7c4-3.19,8-5.98,13-8.4,4-2.4,8-4,10-4.9,3-0.8,5-2,7-3.6,1-1.5,2-3.4,2-5.8,0-2.9-2-5.1-4-6.7s-4-2.7-6-3.4-4-2.3-7-5c-2-2.6-4-6.2-5-10.9l-1-5.8c-1-2.7-1-4.7-2-5.8,0-0.3,0-0.4-1-0.4s-3,0.9-4,2.6c-2,1.7-4,3.6-6,5.6-1,2-4,3.8-6,5.5-3,1.7-6,2.6-8,2.6-8,0-12-2.2-15-6.5-2-3.2-3-6.9-4-11.1-2-1.7-3-2.6-5-2.6-5,0-7,5.2-7,15.7v3.3,11.6,8.9,4.3,3c0,0.9-1,2.9-1,6-1,3.1-1,6.62-1,10.6l-2,11.1v0.17m-145-5.29c9.3,1.36,20,4.27,32.1,8.71,12.1,4.4,19.5,6.7,22.2,6.7,7,0,12.8-3.1,17.6-9.09,1-1.94,1-4.22,1-6.84,0-9.45-5.7-21.4-17.1-35.9l-6.8-9.1c-1.4-1.9-3.1-4.8-5.3-8.7-2.1-3.9-4-6.9-5.5-9-1.3-2.3-3.4-4.6-6.1-6.9-2.6-2.3-5.6-3.8-8.9-4.6-4.2,0.8-7.1,2.2-8.5,4.1s-2.2,4-2.4,6.2c-0.3,2.1-0.9,3.5-1.9,4.2-1,0.6-2.7,1.1-5,1.6-0.5,0-1.4,0-2.7,0.1h-2.7c-5.3,0-8.9,0.6-10.8,1.6-2.5,2.9-3.8,6.2-3.8,9.7,0,1.6,0.4,4.3,1.2,8.1,0.8,3.7,1.2,6.7,1.2,8.8,0,4.1-1.2,8.2-3.7,12.3-2.5,4.3-3.8,7.5-3.8,9.78,1,3.88,7.6,6.61,19.7,8.21m33.3-90.9c0-6.9,1.8-14.5,5.5-23.5,3.6-9,7.2-15,10.7-19-0.2-1-0.7-1-1.5-1l-1-1c-2.9,3-6.4,10-10.6,20-4.2,9-6.4,17.3-6.4,23.4,0,4.5,1.1,8.4,3.1,11.8,2.2,3.3,7.5,8.1,15.9,14.2l10.6,6.9c11.3,9.8,17.3,16.6,17.3,20.6,0,2.1-1,4.2-4,6.5-2,2.4-4.7,3.6-7,3.6-0.2,0-0.3,0.2-0.3,0.7,0,0.1,1,2.1,3.1,6,4.2,5.7,13.2,8.5,25.2,8.5,22,0,39-9,52-27,0-5,0-8.1-1-9.4v-3.7c0-6.5,1-11.4,3-14.6s4-4.7,7-4.7c2,0,4,0.7,6,2.2,1-7.7,1-14.4,1-20.4,0-9.1,0-16.6-2-23.6-1-6-3-11-5-15-2-3-4-6-6-9s-3-6-5-9c-1-4-2-7-2-12-3-5-5-10-8-15-2-5-4-10-6-14l-9,7c-10,7-18,10-25,10-6,0-11-1-14-5l-6-5c0,3-1,7-3,11l-6.3,12c-2.8,7-4.3,11-4.6,14-0.4,2-0.7,4-0.9,4l-7.5,15c-8.1,15-12.2,28.9-12.2,40.4,0,2.3,0.2,4.7,0.6,7.1-4.5-3.1-6.7-7.4-6.7-13m71.6,94.6c-13,0-23,1.76-30,5.25v-0.3c-5,6-10.6,9.1-18.4,9.1-4.9,0-12.6-1.9-23-5.7-10.5-3.6-19.8-6.36-27.9-8.18-0.8-0.23-2.6-0.57-5.5-1.03-2.8-0.45-5.4-0.91-7.7-1.37-2.1-0.45-4.5-1.13-7.1-2.05-2.5-0.79-4.5-1.82-6-3.07-1.38-1.26-2.06-2.68-2.06-4.27,0-1.6,0.34-3.31,1.02-5.13,0.64-1.1,1.34-2.2,2.04-3.2,0.7-1.1,1.3-2.1,1.7-3.1,0.6-0.9,1-1.8,1.4-2.8,0.4-0.9,0.8-1.8,1-2.9,0.2-1,0.4-2,0.4-3s-0.4-4-1.2-9.3c-0.8-5.2-1.2-8.5-1.2-9.9,0-4.4,1-7.9,3.2-10.4s4.3-3.8,6.5-3.8h11.5c0.9,0,2.3-0.5,4.4-1.7,0.7-1.6,1.3-2.9,1.7-4.1,0.5-1.2,0.7-2.1,0.9-2.5,0.2-0.6,0.4-1.2,0.6-1.7,0.4-0.7,0.9-1.5,1.6-2.3-0.8-1-1.2-2.3-1.2-3.9,0-1.1,0-2.1,0.2-2.7,0-3.6,1.7-8.7,5.3-15.4l3.5-6.3c2.9-5.4,5.1-9.4,6.7-13.4,1.7-4,3.5-10,5.5-18,1.6-7,5.4-14,11.4-21l7.5-9c5.2-6,8.6-11,10.5-15s2.9-9,2.9-13c0-2-0.5-8-1.6-18-1-10-1.5-20-1.5-29,0-7,0.6-12,1.9-17s3.6-10,7-14c3-4,7-8,13-10s13-3,21-3c3,0,6,0,9,1,3,0,7,1,12,3,4,2,8,4,11,7,4,3,7,8,10,13,2,6,4,12,5,20,1,5,1,10,2,17,0,6,1,10,1,13,1,3,1,7,2,12,1,4,2,8,4,11,2,4,4,8,7,12,3,5,7,10,11,16,9,10,16,21,20,32,5,10,8,23,8,36.9,0,6.9-1,13.6-3,20.1,2,0,3,0.8,4,2.2s2,4.4,3,9.1l1,7.4c1,2.2,2,4.3,5,6.1,2,1.8,4,3.3,7,4.5,2,1,5,2.4,7,4.2,2,2,3,4.1,3,6.3,0,3.4-1,5.9-3,7.7-2,2-4,3.4-7,4.3-2,1-6,3-12,5.82-5,2.96-10,6.55-15,10.8l-10,8.51c-4,3.9-8,6.7-11,8.4-3,1.8-7,2.7-11,2.7l-7-0.8c-8-2.1-13-6.1-16-12.2-16-1.94-29-2.9-37-2.9"/>

</svg> 
</div>


<body onload="load()">

<div data-role="page" id="pageone">
  <div data-role="header">
      <a href="#" class="ui-btn ui-corner-all ui-shadow ui-icon-eye ui-btn-icon-left" onclick="toggleFullScreen();">FULLSCREEN</a>
      <a href="#" class="ui-btn ui-corner-all ui-shadow ui-icon-info ui-btn-icon-left" onclick="info();">JOB INFO</a> 
    <h1>LOAD SVG</h1>

    <div data-role="navbar">
      <ul>
        <li><a href="#pagezero">SETUP</a></li>
        <li><a href="#pageone" onclick="" class="ui-btn-active ui-state-persist">SVGcode</a></li>

      </ul>
    </div>
  </div>
  
  <div data-role="main" class="ui-content">




    <canvas id="2D" tabindex="1"> </canvas>

  </div>
  <div data-role="footer" style="text-align:center;">



    <span class="ui-btn ui-corner-all ui-shadow ui-icon-plus ui-btn-icon-left" id="loadfont" onchange="startRead()">
       <span>LOAD SVG</span>
       <input type="file" name="files[]" id="file" multiple data-role="none"/>
    </span>

<a href="#" id="resize" class="ui-btn ui-corner-all ui-shadow ui-icon-gear ui-btn-icon-left">RESIZE</a>

      <a href="#" class="ui-btn ui-corner-all ui-shadow ui-icon-action ui-btn-icon-right" onclick="make();">SUBMIT JOB</a>
  </div>
</div> 


<div data-role="page" id="pagezero">
  <div data-role="header">
    <a href="#" class="ui-btn ui-corner-all ui-shadow ui-icon-eye ui-btn-icon-left" onclick="toggleFullScreen();">FULLSCREEN</a>
    <h1>SETUP</h1>

    <div data-role="navbar">
      <ul>
        <li><a href="#pagezero" class="ui-btn-active ui-state-persist">SETUP</a></li>
        <li><a href="#pageone" onclick="">CARDBOARD</a></li>

      </ul>
    </div>
  </div>
  <div data-role="main" class="ui-content">

    <form method="post">
      <fieldset class="ui-field-contain">
        <label for="material">MATERIAL TYPE</label>
        <select name="material" id="material">
          <option value="feed:1000,plunge:200" selected>CARDBOARD</option>
        </select>
      </fieldset>
    </form>

    <form method="post">
      <fieldset class="ui-field-contain">
        <label for="material">FILE TYPE</label>
        <select name="code" id="code">
          <option value="sbp" selected>SBP</option>
<!--          <option value="gcode">GCODE</option> -->
        </select>
      </fieldset>
    </form>


</div>
  <div data-role="footer" style="text-align:center;">

    <a href="#pageone" class="ui-btn ui-corner-all ui-shadow ui-icon-carat-r ui-btn-icon-right">SVGode</a>
  </div>
</div> 


<script type="application/processing" data-processing-target="2D">



int sf = 1;


void setup(){
   size($(window).innerWidth()-30,$(window).innerHeight()-180);
   background(235);
   noFill();
   smooth();  
   frameRate(2);
   strokeCap(ROUND);
   strokeWeight(1);
   textFont(createFont("Arial",6));
}

void draw(){
   background(235);
   size($(window).innerWidth()-30,$(window).innerHeight()-180);
   sf=(height/((ymax-ymin)+20))
   strokeWeight(1);
   scale(sf);
   translate(-xmin+10,-ymin+10);
   stroke(0);
   fill(0,0,200,110);

   for(i=0;i<dots.length;i++){
   beginShape();
      for(j=0;j<dots[i].length;j++){
//              stroke(255,0,0);
//              ellipse(dots[i][j].X,dots[i][j].Y,3,3);
              stroke(0);
              vertex(dots[i][j].X,dots[i][j].Y);
      }
   endShape();
   }

   stroke(0,80);

   noFill();
   beginShape();
      vertex(xmin,ymin);
      vertex(xmax,ymin);
      vertex(xmax,ymax);
      vertex(xmin,ymax);
      vertex(xmin,ymin);
   endShape();

textSize(14/sf);

text((((xmax-xmin)/sf2)/25.4).toFixed(2) + ' x ' + (((ymax-ymin)/sf2)/25.4).toFixed(2) + ' \"',(xmax+5),(ymax));


fill(255,255,0);
ellipse(xmin,ymax,5,5);

}


</script>

<script>

var g = ""
var SVG = []
var SVG2 = []
var SVG3 = ""
var dots = []
var image = ({name:"tux.svg"})
var xmin
var xmax
var ymin
var ymax
var sf2 = 1
var target_width = 101.6
var tool_diameter


function info(){
//   console.log(SVG[0])
   alert(image.name + "\noriginal size\nwidth: " + ((xmax-xmin)).toFixed(2) + "\nheight: " + ((ymax-ymin)).toFixed(2))
}

function load(){
   svg2pg()
}


function startRead() {
    image = document.getElementById("file").files[0];
    if (image) {
        if (image.type.match("/svg/*")) {
            getAsImage(image);
        }
        else {
              alert(image.name + " IS NOT A SVG FILE");
        }
    }
}

function getAsImage(readFile) {
    var reader = new FileReader();
    reader.readAsDataURL(readFile);
    reader.onload = addImg;
}

function addImg(imgsrc) {

   SVG2 = imgsrc.target.result
   SVG2 = SVG2.slice(SVG2.indexOf(",")+1)
   SVG2 = window.atob(SVG2)
   SVG2 = SVG2.slice((SVG2.indexOf('<svg')),(SVG2.indexOf('</svg>'))+6)
   SVG2 = SVG2.replace('<svg','<svg id="svg"')

   console.log(SVG2)

   $( "#svg" ).replaceWith(SVG2);
   svg2pg()
}


function svg2pg(){

   svg_paths=[]
   SVG = []
   SVG2 = []
   dots = []
   SVG3 = ''
   flatten(document.getElementById('svg'));
//   console.log(svg_paths)

   for(i=0;i<svg_paths.length;i++){
   SVG.push([])
      for(j=0;j<svg_paths[i].length;j++){

      SVG[i]+=(svg_paths[i][j])
//      SVG3 +=svg_paths[i][j]

      }
   }

//   SVG3 = Raphael._pathToAbsolute(SVG3);
//   console.log(SVG3)


   svg_paths=[]
   for(i=0;i<SVG.length;i++){
      svg_paths[i]=Raphael._pathToAbsolute(SVG[i]);    
   }
//   console.log(svg_paths)
   SVG=[]

//   svg_paths.push(SVG3)

   var curve
   var shape_no = 0

   for(i=0;i<svg_paths.length;i++){
   for(j=0;j<svg_paths[i].length;j++){
            if((svg_paths[i][j][0].startsWith('M')==true) || (svg_paths[i][j][0].startsWith('m')==true)){
               dots.push([])
               shape_no=dots.length-1
               dots[shape_no].push({X:svg_paths[i][j][1],Y:svg_paths[i][j][2]})
            }
            else if((svg_paths[i][j][0].startsWith('L')==true) || (svg_paths[i][j][0].startsWith('l')==true)){
               dots[shape_no].push({X:svg_paths[i][j][1],Y:svg_paths[i][j][2]})
            }
            else if((svg_paths[i][j][0].startsWith('Z')==false) && (svg_paths[i][j][0].startsWith('z')==false)){
               curve = ""
               for(j2=0;j2<svg_paths[i][j].length;j2++){
                  curve +=(svg_paths[i][j][j2]+',')
               }
                  curve = "M," + (svg_paths[i][j-1][(svg_paths[i][j-1].length)-2]) + ',' + (svg_paths[i][j-1][(svg_paths[i][j-1].length)-1]) + ',' + curve
                  
               for(j2=0;j2<(parseInt(Snap.path.getTotalLength(curve)));j2=j2+1){
                  dots[shape_no].push({X:Snap.path.getPointAtLength(curve, j2).x,Y:Snap.path.getPointAtLength(curve, j2).y})   
               }
           
            }
   }

   }

//close all paths
for(i=0;i<dots.length;i++){
   dots[i].push(dots[i][0])
}

//console.log(dots)

   xmin = []
   xmax = []
   ymin = []
   ymax = []

   for(i=0;i<dots.length;i++){
      for(j=0;j<dots[i].length;j++){
      xmax.push(dots[i][j].X)
      xmin.push(dots[i][j].X)
      ymax.push(dots[i][j].Y)
      ymin.push(dots[i][j].Y)
      }
   }
   xmax = Math.max.apply(Math, xmax)
   xmin = Math.min.apply(Math, xmin)
   ymax = Math.max.apply(Math, ymax)
   ymin = Math.min.apply(Math, ymin)
   sf2 = ((xmax-xmin)/target_width)
}


$( "#resize" ).click(function() {

   target_width = eval(window.prompt("ENTER NEW WIDTH (INCH)")*25.4)

   if((target_width!=null)){
      sf2 = ((xmax-xmin)/target_width)
   }
   else{
		
      sf2 = sf2
   }
	//console.log(target_width)
   
});


// toggle full screen
function toggleFullScreen() {
   if (!document.fullscreenElement &&    // alternative standard method
      !document.mozFullScreenElement && !document.webkitFullscreenElement) {  // current working methods
    if (document.documentElement.requestFullscreen) {
      document.documentElement.requestFullscreen()
    } else if (document.documentElement.mozRequestFullScreen) {
      document.documentElement.mozRequestFullScreen()
    } else if (document.documentElement.webkitRequestFullscreen) {
      document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT)
    }
  } else {
    if (document.cancelFullScreen) {
      document.cancelFullScreen()
    } else if (document.mozCancelFullScreen) {
      document.mozCancelFullScreen()
    } else if (document.webkitCancelFullScreen) {
      document.webkitCancelFullScreen()
    }
  }
}



function make(){

//dots.reverse()
//for(i=0;i<dots.length;i++){
//   dots[i].reverse()
//}
//material = eval('({' + (document.getElementById("material").value) + '})')

if((document.getElementById("code").value)=="gcode"){

   g=""
   g+="g21\n"
   g+="g0z5\n"
//   g+="m4\n" //spindle on
   g+="g4p2\n"
   g+="g1f500\n"

for(i=0;i<dots.length;i++){

   for(j=0;j<dots[i].length;j++){
           if(j==0){
           g+="g0x"+((dots[i][j].X-xmin)/sf2).toFixed(2)+"y"+(((ymax-ymin)/sf2)+((ymin-(dots[i][j].Y))/sf2)).toFixed(2) + "\n"
           g+="g1z-0.5f200\n"
           }
           else{
           g+="g1x"+((dots[i][j].X-xmin)/sf2).toFixed(2)+"y"+(((ymax-ymin)/sf2)+((ymin-(dots[i][j].Y))/sf2)).toFixed(2) + "f500\n"
           }
   }

g+="g0z3\n"

}

//   g+="m5\n"
   g+="m30\n"
   //console.log(g);
   fabmo.submitJob({
      file : g,
      filename : image.name + '.g',
      name : image.name,
      description : (((xmax-xmin)/sf2).toFixed(2))+" x "+(((ymax-ymin)/sf2).toFixed(2))+" mm"
   });

}


else if((document.getElementById("code").value)=="sbp"){

   g=""
   g+="'UNITS = INCH"
   g+="JZ,0.25\n"
   g+="J2,0,0\n"
   g+="MIB,0,0,30,0.1\n"
   g+="PAUSE 3\n"
   g+="MS,30,10\n"
//SO,1,1 //spindle on
//SO,1,0 //spindle off


for(i=0;i<dots.length;i++){

   for(j=0;j<dots[i].length;j++){
           if(j==0){

			  g+="MA,"+ (Math.atan2(dots[i][j].X,dots[i][j].Y)*57.296).toFixed(3) +"\n"

           g+="J2,"+(((dots[i][j].X-xmin)/sf2)/25.4).toFixed(3)+","+((((ymax-ymin)/sf2)+((ymin-(dots[i][j].Y))/sf2))/25.4).toFixed(3) + "\n" 
           

           g+="MZ,-0.125\n"
           }
           else{

           g+="MA,"+ (Math.atan2(dots[i][j].X,dots[i][j].Y)*57.296).toFixed(3) +"\n"
           g+="M2,"+(((dots[i][j].X-xmin)/sf2)/25.4).toFixed(3)+","+((((ymax-ymin)/sf2)+((ymin-(dots[i][j].Y))/sf2))/25.4).toFixed(3) + "\n"
           }
   }

g+="JZ,0.125\n"


}

g+="MIB,0,0,0,0\n"
g+="J3,0,0,0.25\n"

   fabmo.submitJob({
      file : g,
      filename : image.name + '.sbp',
      name : image.name,
      description : (((xmax-xmin)/sf2).toFixed(2))+" x "+(((ymax-ymin)/sf2).toFixed(2))+" mm"
   });


}

}
</script>

</body>
</html>

